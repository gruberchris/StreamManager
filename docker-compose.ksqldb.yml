version: '3.8'

# ksqlDB-specific services
# Run with: docker-compose -f docker-compose.base.yml -f docker-compose.ksqldb.yml up
services:
  ksqldb-server:
    image: confluentinc/cp-ksqldb-server:7.6.0
    hostname: ksqldb-server
    container_name: ksqldb-server
    depends_on:
      - broker
      - schema-registry
    ports:
      - "8088:8088"
    # Docker resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'          # Max 2 CPU cores
          memory: 2G           # Max 2GB RAM
        reservations:
          cpus: '0.5'          # Min 0.5 CPU cores
          memory: 512M         # Min 512MB RAM
    environment:
      KSQL_CONFIG_DIR: "/etc/ksql"
      KSQL_BOOTSTRAP_SERVERS: "broker:29092"
      KSQL_HOST_NAME: ksqldb-server
      KSQL_LISTENERS: "http://0.0.0.0:8088"
      
      # Memory and buffering limits
      KSQL_CACHE_MAX_BYTES_BUFFERING: 10485760  # 10MB buffer per query
      KSQL_KSQL_STREAMS_BUFFER_MEMORY: 33554432  # 32MB total buffer memory
      
      # Query processing limits
      KSQL_KSQL_QUERY_PULL_MAX_ALLOWED_OFFSET_LAG: 10000  # Max records behind for pull queries
      KSQL_KSQL_QUERY_PUSH_V2_MAX_HOURLY_BANDWIDTH_MEGABYTES: 1000  # 1GB/hour per push query
      KSQL_KSQL_QUERY_PUSH_V2_CATCHUP_CONSUMER_MSG_WINDOW: 50  # Limit catchup window
      
      # Stream processing limits
      # NOTE: This is threads PER QUERY, not total queries
      # With 50 queries Ã— 2 threads = 100 total threads
      KSQL_KSQL_STREAMS_NUM_STREAM_THREADS: 2  # Threads per query (was 4)
      KSQL_KSQL_STREAMS_COMMIT_INTERVAL_MS: 2000  # Commit every 2 seconds
      
      # JVM heap settings (within Docker memory limit)
      KSQL_HEAP_OPTS: "-Xms512M -Xmx1536M"  # Min 512MB, Max 1.5GB heap
      
      KSQL_KSQL_SCHEMA_REGISTRY_URL: "http://schema-registry:8081"
      KSQL_KSQL_SERVICE_ID: "stream_manager_"
      KSQL_KSQL_CONNECT_URL: "http://connect:8083"
      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_REPLICATION_FACTOR: 1
      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE: 'true'
      KSQL_KSQL_STREAM_AUTO_CREATE: 'true'

  # Optional: CLI for debugging
  ksqldb-cli:
    image: confluentinc/cp-ksqldb-cli:7.6.0
    container_name: ksqldb-cli
    depends_on:
      - ksqldb-server
    entrypoint: /bin/sh
    tty: true